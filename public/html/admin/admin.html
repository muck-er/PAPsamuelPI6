<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <title>Admin - OthrysFit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="../../images/OthrysFit.ico" type="image/x-icon" />
  </head>
  <body class="bg-gray-100 font-sans">
    <header class="bg-white shadow p-4 flex justify-between items-center">
      <div class="text-xl font-bold text-orange-600 flex items-center gap-2">
        <img src="../../images/OthrysFit.ico" alt="Logo" class="w-6 h-6" />
        <span>OthrysFit - Admin</span>
      </div>
      <a
        href="/src/php/logout.php"
        class="text-red-600 font-semibold hover:underline"
        >Sair</a
      >
    </header>
    <main class="p-6 space-y-6">
      <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white p-4 rounded-lg shadow text-center">
          <h3 class="text-sm text-gray-500">Utilizadores</h3>
          <p class="text-2xl font-bold text-gray-800" id="total-users">--</p>
        </div>
        <div class="bg-white p-4 rounded-lg shadow text-center">
          <h3 class="text-sm text-gray-500">Objetivos</h3>
          <p class="text-2xl font-bold text-gray-800" id="total-objectives">
            --
          </p>
        </div>
        <div class="bg-white p-4 rounded-lg shadow text-center">
          <h3 class="text-sm text-gray-500">Treinos Ativos</h3>
          <p class="text-2xl font-bold text-gray-800" id="total-workouts">--</p>
        </div>
      </section>
      <section class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">
          Lista de Utilizadores
        </h2>
        <table class="min-w-full table-auto text-left text-sm">
          <thead class="bg-gray-100 text-gray-600 font-medium">
            <tr>
              <th class="p-2">ID</th>
              <th class="p-2">Nome</th>
              <th class="p-2">Email</th>
              <th class="p-2">Ações</th>
            </tr>
          </thead>
          <tbody id="user-table-body"></tbody>
        </table>
      </section>
    </main>
    <div
      id="modal-edit"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
    >
      <div class="bg-white rounded-lg p-6 w-96 shadow-lg">
        <h3 class="text-lg font-semibold mb-4">Editar Usuário</h3>
        <form id="edit-user-form" class="space-y-4">
          <input type="hidden" id="edit-user-id" />
          <div>
            <label class="block mb-1 font-medium">Nome</label>
            <input
              id="edit-user-nome"
              type="text"
              class="w-full border px-3 py-2 rounded"
              required
            />
          </div>
          <div>
            <label class="block mb-1 font-medium">Email</label>
            <input
              id="edit-user-email"
              type="email"
              class="w-full border px-3 py-2 rounded"
              required
            />
          </div>
          <div class="flex justify-end gap-2">
            <button
              type="button"
              onclick="fecharModal('modal-edit')"
              class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="px-4 py-2 rounded bg-orange-600 text-white hover:bg-orange-700"
            >
              Salvar
            </button>
          </div>
        </form>
      </div>
    </div>
    <div
      id="modal-delete"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
    >
      <div class="bg-white rounded-lg p-6 w-80 shadow-lg text-center">
        <h3 class="text-lg font-semibold mb-4">Confirmar Remoção</h3>
        <p class="mb-6">Tem certeza que deseja remover este usuário?</p>
        <div class="flex justify-center gap-4">
          <button
            onclick="fecharModal('modal-delete')"
            class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400"
          >
            Cancelar
          </button>
          <button
            id="btn-confirm-delete"
            class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700"
          >
            Sim, remover
          </button>
        </div>
      </div>
    </div>
    <div
      id="modal-confirmation"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
    >
      <div
        class="bg-white rounded-lg shadow-lg p-6 max-w-sm w-full text-center"
      >
        <p id="confirmation-message" class="text-gray-800 text-lg mb-4"></p>
        <button
          onclick="fecharModal('modal-confirmation')"
          class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700 transition"
        >
          Fechar
        </button>
      </div>
    </div>
    <div
      id="modal-promover-admin"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
    >
      <div class="bg-white rounded-lg p-6 w-96 shadow-lg text-center">
        <h3 class="text-lg font-semibold mb-4">Promover a Administrador</h3>
        <p class="mb-6">
          Tem a certeza que deseja tornar este utilizador um administrador?
        </p>
        <div class="flex justify-center gap-4">
          <button
            onclick="fecharModal('modal-promover-admin')"
            class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400"
          >
            Cancelar
          </button>
          <button
            id="btn-confirm-promover"
            class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700"
          >
            Sim, promover
          </button>
        </div>
      </div>
    </div>

    <script>
      function abrirModal(id) {
        document.getElementById(id).classList.remove("hidden");
      }
      function fecharModal(id) {
        document.getElementById(id).classList.add("hidden");
      }

      function mostrarConfirmacao(mensagem) {
        const modal = document.getElementById("modal-confirmation");
        const mensagemElem = document.getElementById("confirmation-message");
        mensagemElem.textContent = mensagem;
        abrirModal("modal-confirmation");
      }

      let userIdParaDeletar = null;

      document.addEventListener("DOMContentLoaded", () => {
        fetch("/src/php/admin_dashboard_data.php")
          .then((res) => res.json())
          .then((data) => {
            document.getElementById("total-users").textContent =
              data.total_users;
            document.getElementById("total-objectives").textContent =
              data.total_objectives;
            document.getElementById("total-workouts").textContent =
              data.total_workouts;

            const tbody = document.getElementById("user-table-body");
            tbody.innerHTML = "";
            data.users.forEach((user) => {
              const tr = document.createElement("tr");
              tr.className = "border-b hover:bg-gray-50";
              const acoes =
                user.role !== "admin"
                  ? `
              <button class="text-blue-600 hover:underline" onclick="editarUsuario(${
                user.id
              }, '${user.nome.replace(/'/g, "\\'")}', '${user.email.replace(
                      /'/g,
                      "\\'"
                    )}')">Editar</button>
              <button class="text-red-600 hover:underline ml-2" onclick="removerUsuario(${
                user.id
              })">Remover</button>
              <button class="text-green-600 hover:underline ml-2" onclick="promoverParaAdmin(${
                user.id
              })">Tornar Admin</button>
              `
                  : `<span class="text-gray-400 italic">Administrador</span>`;

              tr.innerHTML = `
    <td class="p-2">${user.id}</td>
    <td class="p-2">${user.nome}</td>
    <td class="p-2">${user.email}</td>
    <td class="p-2">${acoes}</td>
  `;

              tbody.appendChild(tr);
            });
          })
          .catch((err) => {
            console.error("Erro ao carregar dados do admin:", err);
            mostrarConfirmacao("Erro ao carregar dados.");
          });
      });

      function editarUsuario(id, nome, email) {
        document.getElementById("edit-user-id").value = id;
        document.getElementById("edit-user-nome").value = nome;
        document.getElementById("edit-user-email").value = email;
        abrirModal("modal-edit");
      }

      document
        .getElementById("edit-user-form")
        .addEventListener("submit", (e) => {
          e.preventDefault();
          const id = document.getElementById("edit-user-id").value;
          const nome = document.getElementById("edit-user-nome").value.trim();
          const email = document.getElementById("edit-user-email").value.trim();

          fetch("/src/php/editar_usuario.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id, nome, email }),
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                fecharModal("modal-edit");
                mostrarConfirmacao("Utilizador atualizado com sucesso!");
                setTimeout(() => location.reload(), 10000);
              } else {
                fecharModal("modal-edit");
                mostrarConfirmacao(
                  "Erro ao atualizar: " + (data.error || "Erro desconhecido")
                );
              }
            })
            .catch(() => {
              fecharModal("modal-edit");
              mostrarConfirmacao("Erro ao conectar com o servidor.");
            });
        });

      function removerUsuario(id) {
        userIdParaDeletar = id;
        abrirModal("modal-delete");
      }

      document
        .getElementById("btn-confirm-delete")
        .addEventListener("click", () => {
          if (!userIdParaDeletar) return fecharModal("modal-delete");

          fetch("/src/php/remover_usuario.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: userIdParaDeletar }),
          })
            .then((res) => res.json())
            .then((data) => {
              fecharModal("modal-delete");
              userIdParaDeletar = null;
              if (data.success) {
                mostrarConfirmacao("Utilizador removido com sucesso!");
                setTimeout(() => location.reload(), 10000);
              } else {
                mostrarConfirmacao(
                  "Erro ao remover: " + (data.error || "Erro desconhecido")
                );
              }
            })
            .catch(() => {
              fecharModal("modal-delete");
              userIdParaDeletar = null;
              mostrarConfirmacao("Erro ao conectar com o servidor.");
            });
        });
      let userIdParaPromover = null;

      function promoverParaAdmin(id) {
        userIdParaPromover = id;
        abrirModal("modal-promover-admin");
      }

      document
        .getElementById("btn-confirm-promover")
        .addEventListener("click", () => {
          if (!userIdParaPromover) return fecharModal("modal-promover-admin");

          fetch("/src/php/promover_admin.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: userIdParaPromover }),
          })
            .then((res) => res.json())
            .then((data) => {
              fecharModal("modal-promover-admin");
              userIdParaPromover = null;
              if (data.success) {
                mostrarConfirmacao(
                  "Utilizador promovido a administrador com sucesso!"
                );
                setTimeout(() => location.reload(), 3000);
              } else {
                mostrarConfirmacao(
                  "Erro ao promover: " + (data.error || "Erro desconhecido")
                );
              }
            })
            .catch(() => {
              fecharModal("modal-promover-admin");
              userIdParaPromover = null;
              mostrarConfirmacao("Erro ao conectar com o servidor.");
            });
        });
    </script>
  </body>
</html>
